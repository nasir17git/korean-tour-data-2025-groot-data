name: Daily Tourism Data Sync

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (UTC ê¸°ì¤€, í•œêµ­ì‹œê°„ 11ì‹œ)
    - cron: '0 2 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if recent sync exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-tourism-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set timezone to KST
        run: |
          echo "Current UTC time: $(date -u)"
          echo "Current KST time: $(TZ='Asia/Seoul' date)"
      
      - name: Trigger Supabase Edge Function
        id: sync
        run: |
          echo "ğŸš€ Starting tourism data sync..."
          
          # Edge Function URL êµ¬ì„±
          FUNCTION_URL="https://${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/tourism-sync"
          
          # API í˜¸ì¶œ
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"source": "github_actions", "force": "${{ github.event.inputs.force_sync }}"}' \
            "$FUNCTION_URL")
          
          # HTTP ìƒíƒœ ì½”ë“œì™€ ì‘ë‹µ ë¶„ë¦¬
          http_code=$(echo $response | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body=$(echo $response | sed -e 's/HTTPSTATUS:.*//g')
          
          echo "HTTP Status: $http_code"
          echo "Response Body: $body"
          
          # ì‘ë‹µì„ íŒŒì¼ë¡œ ì €ì¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©)
          echo "$body" > sync_result.json
          
          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Sync request completed successfully"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Sync request failed with HTTP $http_code"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Parse and display results
        if: always()
        run: |
          if [ -f sync_result.json ]; then
            echo "ğŸ“Š Sync Results:"
            
            # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON íŒŒì‹± ë° í¬ë§·íŒ…
            if command -v jq &> /dev/null; then
              echo "$(cat sync_result.json | jq '.')"
              
              # ìš”ì•½ ì •ë³´ ì¶”ì¶œ
              success=$(cat sync_result.json | jq -r '.success // false')
              total_time=$(cat sync_result.json | jq -r '.total_execution_time // 0')
              
              echo ""
              echo "ğŸ“ˆ Summary:"
              echo "- Overall Success: $success"
              echo "- Total Execution Time: ${total_time}s"
              
              # ê° API ê²°ê³¼ í‘œì‹œ
              echo ""
              echo "ğŸ” API Results:"
              cat sync_result.json | jq -r '.results[]? | "- \(.api_type): \(.status) (\(.new // 0) new, \(.updated // 0) updated, \(.execution_time // 0)s)"'
              
            else
              echo "Raw response:"
              cat sync_result.json
            fi
          else
            echo "âŒ No sync result file found"
          fi
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "ğŸš¨ Tourism data sync failed!"
          echo "Timestamp: $(date -u)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          
          # ì‹¤íŒ¨ ì‹œ ì¶”ê°€ ì•Œë¦¼ ë¡œì§ (Slack, Discord ë“±)ì„ ì—¬ê¸°ì— ì¶”ê°€í•  ìˆ˜ ìˆìŒ
      
      - name: Upload sync results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_number }}
          path: sync_result.json
          retention-days: 30

  # ì„ íƒì : ë™ê¸°í™” ìƒíƒœ í™•ì¸ ì‘ì—…
  check-sync-health:
    runs-on: ubuntu-latest
    needs: sync-tourism-data
    if: always()
    
    steps:
      - name: Check recent sync logs
        run: |
          echo "ğŸ” Checking recent sync health..."
          
          # ìµœê·¼ ë™ê¸°í™” ë¡œê·¸ í™•ì¸ì„ ìœ„í•œ ì¶”ê°€ API í˜¸ì¶œ
          # (í•„ìš”ì‹œ ë³„ë„ Edge Function ìƒì„±)
          
          echo "Health check completed"

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  actions: read
